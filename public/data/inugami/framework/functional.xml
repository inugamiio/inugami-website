<xml>
    <src name="dependencies_maven" type="xml" title="Maven dependencies">
        <![CDATA[
<dependency>
    <groupId>io.inugami.framework</groupId>
    <artifactId>inugami_api_interfaces</artifactId>
</dependency>
]]>
    </src>

        <src name="dependencies_java" type="java" title="Java dependencies">
        <![CDATA[
requires io.inugami.framework.interfaces;
]]>
    </src>


    <src name="ActionWithException" type="java" title="ActionWithException">
        <![CDATA[
@FunctionalInterface
public interface ActionWithException {
    <T> T process() throws Throwable;
}
]]>
    </src>

        <src name="ActionWithExceptionUsage" type="java" title="Usage of ActionWithException">
        <![CDATA[
@UtilityClass
public class Asserts {
    //...
    public static <T> T wrapErrorForSupplierWithException(final ActionWithException action, final ErrorCode errorCode) {
        return wrapErrorForSupplierWithException(action, errorCode, null);
    }
}

public class UserService{
    // ...

    public void getUserById(final String id) {
        final UserDTO user = Asserts.wrapErrorForSupplierWithException(()-> userDao.getElementById(id),
                                                                        UserError.READ_USER_NOT_FOUND);
    }
}
]]>
    </src>

<src name="BiConsumerWithException" type="java" title="BiConsumerWithException">
        <![CDATA[
@FunctionalInterface
public interface BiConsumerWithException<T,V> {
    void process(final T value, final V secondValue) throws Exception;
}
]]>
    </src>

    <src name="BiConsumerWithException" type="java" title="BiConsumerWithException">
        <![CDATA[
@FunctionalInterface
public interface BiConsumerWithException<T,V> {
    void process(final T value, final V secondValue) throws Exception;
}
]]>
    </src>

        <src name="BiConsumerWithExceptionUsage" type="java" title="Usage of BiConsumerWithException">
        <![CDATA[
@UtilityClass
public class Asserts {
    //...
    public <T> void assertModel(final Collection<T> models,
                                final BiConsumerWithException<T, Integer>... validations) {
        // ...
    }
}


@RequiredArgsConstructor
@Service
public class UserService{
    @Transactional
    public Collection<UserDTO> create(final Collection<UserDTO> values) {
        assertNotEmpty(CREATE_INVALID_DATA, values);

        assertModel(values,
            (v, index) -> assertNull(fromErrorCode(CREATE_UID_FORBIDDEN)
                            .addField(FIELD_UID, index)
                            .build(), v.getUid()),

            (v, index) -> {
                assertNotEmpty(fromErrorCode(CREATE_FIRSTNAME_INVALID)
                            .addField(FIELD_FIRSTNAME, index)
                            .build(), v.getFirstName());

                v.setFirstName(v.getFirstName().trim());
                assertLowerOrEquals(fromErrorCode(CREATE_FIRSTNAME_INVALID)
                            .addField(FIELD_FIRSTNAME, index)
                            .build(), MAX_SIZE, v.getFirstName().length());
            },

            (v, index) -> {
                assertNotEmpty(fromErrorCode(CREATE_LASTNAME_INVALID)
                            .addField(FIELD_LASTNAME, index)
                            .build(), v.getLastName());
                v.setLastName(v.getLastName().trim());
                assertLowerOrEquals(fromErrorCode(CREATE_LASTNAME_INVALID)
                            .addField(FIELD_LASTNAME, index)
                            .build(), MAX_SIZE, v.getLastName().length());
            },

            (v, index) -> {
                assertNotEmpty(fromErrorCode(CREATE_EMAIL_INVALID)
                            .addField(FIELD_EMAIL, index)
                            .build(), v.getEmail());
                v.setEmail(v.getEmail().trim());
                assertRegexMatch(fromErrorCode(CREATE_EMAIL_INVALID)
                            .addField(FIELD_EMAIL, index)
                            .build(), EMAIL_REGEX, v.getEmail());
            });

        return userDao.create(values);
    }
]]>
    </src>


<src name="ConsumerWithException" type="java" title="ConsumerWithException">
        <![CDATA[
@FunctionalInterface
public interface ConsumerWithException<T> {
    void process(final T value) throws Exception;
}
]]>
    </src>

    <src name="ConsumerWithExceptionUsage" type="java" title="Usage of ConsumerWithException">
        <![CDATA[
@RequiredArgsConstructor
@Service
public class UserService {
    private final UserDao dao;
    private final List<ConsumerWithException<UserDTO>> listeners;

    @Transactional
    void synchronizeUsers(){
         List<UserDTO> users = dao.searchUserToSynchronize();

         users.forEach(this::invokeListeners);
    }

    protected void invokeListeners(UserDTO user ){
        for(ConsumerWithException<UserDTO> listener : listeners){
            RunSafeUtils.runSafeVoid(()-> listener.process(user));
        }
    }
}
]]>
    </src>

<src name="BiConsumerWithException" type="java" title="BiConsumerWithException">
        <![CDATA[
@FunctionalInterface
public interface BiConsumerWithException<T,V> {
    void process(final T value, final V secondValue) throws Exception;
}
]]>
    </src>


<src name="FunctionWithException" type="java" title="FunctionWithException">
        <![CDATA[
@FunctionalInterface
public interface FunctionWithException<I, O, E extends Throwable> {
    O process(final I input) throws E;
}
]]>
    </src>


    <src name="FunctionWithExceptionUsage" type="java" title="Usage of FunctionWithException">
        <![CDATA[
@RequiredArgsConstructor
@Service
public OrderOrchestratorService{
    private final OrderService    orderService;
    private final StockService    stockService;
    private final TaxesService    taxeService;
    private final ConsumerService consumerService;

    @Transactional
    public OrderDTOStatus processOrder(final OrderDTO order){
        OrderDTOStatus result = null;

        //--- Chain of Command
        List<FunctionWithException<OrderDTOStatus, OrderDTO, CheckedException>> steps = List.of(
            ()-> this.validateOrder(order),
            ()-> this.reserveStock(order),
            ()-> this.calculateTaxes(order),
            ()-> this.notifyConsumers(order)
        );

        //--- process synchronization
        for(final var step :steps){
            try{
                result = step.process(Optional.ofNullable(result)
                                              .map(OrderDTOStatus::getOrder)
                                              .orElse(user));
            }catch(CheckedException e){
                esbService.sendFailSynchronization(user);
                Asserts.throwException(OrderError.ORDER_PROCESSING_ERROR)
            }
        }
        
        return result;
    }

    protected OrderDTOStatus validateOrder(final OrderDTO user) throws UncheckedException{
        // ...
    }
    protected OrderDTOStatus reserveStock(final OrderDTO user) throws UncheckedException{
        // ...
    }
    protected OrderDTOStatus calculateTaxes(final OrderDTO user) throws UncheckedException{
        // ...
    }
    protected OrderDTOStatus notifyConsumers(final OrderDTO user) throws UncheckedException{
        // ...
    }
}
]]>
    </src>


<src name="GenericActionWithException" type="java" title="GenericActionWithException">
        <![CDATA[
@FunctionalInterface
public interface GenericActionWithException<T> {
    T process() throws Throwable;
}
]]>
    </src>

    <src name="VoidFunction" type="java" title="VoidFunction">
        <![CDATA[
@FunctionalInterface
public interface VoidFunction {
    void process();
}
]]>
    </src>

    <src name="VoidFunctionWithException" type="java" title="VoidFunctionWithException">
        <![CDATA[
@FunctionalInterface
public interface VoidFunctionWithException {
    void process() throws Exception;
}
]]>
    </src>


    <src name="VoidFunctionWithExceptionUsage" type="java" title="Usage of VoidFunctionWithException">
        <![CDATA[
public void processAndCleanup(OrderDTO order) {
    try {
        businessService.save(order);
    } finally {
        RunSafeUtils.runSafeVoid(() -> resourceManager.releaseLock(order.getId()));
    }
}
]]>
    </src>

    <src name="ValidatorFunction" type="java" title="ValidatorFunction">
        <![CDATA[
@FunctionalInterface
public interface ValidatorFunction<T, E extends Exception> {
    void validate(final T input) throws E;
}
]]>
    </src>

        <src name="ValidatorFunctionUsage" type="java" title="Usage of ValidatorFunction">
        <![CDATA[
@Service
public class UserValidationService {

    public void validateUserCreation(UserDTO user) throws CheckedException {
        List<ValidatorFunction<UserDTO, CheckedException>> validators = List.of(
            this::checkEmailFormat,
            this::checkPasswordStrength,
            this::checkDuplicateAccount
        );

        for (var validator : validators) {
            validator.validate(user);
        }
    }

    private void checkEmailFormat(UserDTO user) throws UserException {
        final String email = Optional.ofNullable(user).map(UserDTO::getEmail).orElse("");
        if(!email.contains("@")){
            throw new UserException(ErrorCode.INVALID_EMAIL);
        }
    }
    //...
}
]]>
    </src>

    <src name="IsEmptyFacet" type="java" title="IsEmptyFacet">
        <![CDATA[
@FunctionalInterface
public interface IsEmptyFacet {
    boolean isEmpty();
}
]]>
    </src>

        <src name="IsEmptyFacetUsage" type="java" title="Usage of IsEmptyFacet">
        <![CDATA[
@Data
public class AddressDTO implements IsEmptyFacet {
    private String street;
    private String city;

    @Override
    public boolean isEmpty() {
        return StringUtils.isBlank(street) && StringUtils.isBlank(city);
    }
}

//-----------------------
public class AddressService {
    public List<AddressDTO> sanitizeAddresses(List<AddressDTO> addresses) {
        return addresses.stream()
                        .filter(addr -> !addr.isEmpty()) 
                        .toList();
    }
}
]]>
    </src>


    <src name="SupplierWithException" type="java" title="SupplierWithException">
        <![CDATA[
@FunctionalInterface
public interface SupplierWithException<T, E extends Exception> {
    T get() throws E;
}
]]>
    </src>

        <src name="SupplierWithExceptionUsage" type="java" title="Usage of SupplierWithException">
        <![CDATA[
@RequiredArgsConstructor
@Service
public class ProductService {
    private final List<StockService> stockServices;

    public List<ProductStock> findProductInStocks(final String productUid){
        final List<ProductStock> result = new ArrayList<>();


        for(StockService stockService : stockServices){
            searchProductInRegionalStock(()-> stockService.findProduct(productUid), 
                                        stockService.getRegion(),
                                        result::add);
        }

        return;
    }

    protected void searchProductInRegionalStock(SupplierWithException<ProductStock, CheckedException> action,
                                                String region,
                                                Consumer<ProductStock> consumer){
        try{
            FunctionalUtils.applyIfNotNull(action.get(), consumer::accept)
        }catch(CheckedException e){
            WarningContext.getInstance().addWarnings(UserWarning.PRODUCT_NOT_AVAILABLE
                                        .toBuilder()
                                        .addMessageDetail("Product isn't available in stock region {0}", region));
        }
    }
}
]]>
    </src>

    <src name="SupplierWithThrowable" type="java" title="SupplierWithThrowable">
        <![CDATA[
@FunctionalInterface
public interface SupplierWithThrowable<T> {
    T get() throws Throwable;
}
]]>
    </src>



    <src name="SupplierWithThrowableUsage" type="java" title="Usage of SupplierWithThrowable">
        <![CDATA[
@RequiredArgsConstructor
@Service
public class ProductService {
    private final List<StockService> stockServices;

    public List<ProductStock> findProductInStocks(final String productUid){
        final List<ProductStock> result = new ArrayList<>();


        for(StockService stockService : stockServices){
            searchProductInRegionalStock(()-> stockService.findProduct(productUid), 
                                        stockService.getRegion(),
                                        result::add);
        }

        return;
    }

    protected void searchProductInRegionalStock(SupplierWithException<ProductStock, CheckedException> action,
                                                String region,
                                                Consumer<ProductStock> consumer){
        try{
            FunctionalUtils.applyIfNotNull(action.get(), consumer::accept)
        }catch(Throwable e){
            WarningContext.getInstance().addWarnings(UserWarning.PRODUCT_NOT_AVAILABLE
                                        .toBuilder()
                                        .addMessageDetail("Product isn't available in stock region {0}", region));
        }
    }
}
]]>
    </src>

    <src name="TaskStartListener" type="java" title="TaskStartListener">
        <![CDATA[
@FunctionalInterface
public interface TaskStartListener {
    void onStart(final long time, final String name);
}
]]>
    </src>

    <src name="TaskFinishListener" type="java" title="TaskFinishListener">
        <![CDATA[
@FunctionalInterface
public interface TaskFinishListener {
    void onFinish(final long time, final long delay, final String name, final Object result, final Exception error);
}
]]>
    </src>

        <src name="FunctionalUtils" type="java" title="FunctionalUtils">
        <![CDATA[
@UtilityClass
public final class FunctionalUtils {


    // =========================================================================
    // OR
    // =========================================================================
    public static <T> T or(T value, T ref) { }

    public static <T> T or(T value, Supplier<T> ref) { }

    public static <T> Optional<T> orOptional(T value, Supplier<T> supplier) { }

    // =================================================================================================================
    // IF NOT NULL
    // =================================================================================================================
    public static <T, R> R ifNotNull(final T value, final Function<T, R> processor)  { }

    // =================================================================================================================
    // APPLY IF NOT NULL
    // =================================================================================================================
    public static <T> boolean applyIfNotNull(final T data, final Consumer<T> consumer) { }

    public static <T> boolean applyIfNotNull(final T data, final T defaultValue, final Consumer<T> consumer) { }

    public static <T> void processIfNull(T object, VoidFunction supplier)  { }

    public static <T> void processIfNotNull(T object, VoidFunction supplier) { }

    public static <T> void processIfNotNull(T object, Consumer<T> supplier) { }


    // =================================================================================================================
    // APPLY IF NULL
    // =================================================================================================================
    public static <T> T applyIfNull(final T data, final Supplier<T> supplier)  { }


    // =================================================================================================================
    // APPLY IF EMPTY
    // =================================================================================================================
    public static <T extends Collection<?>> T applyIfEmpty(final T data, final Supplier<T> supplier) { }

    public static <T extends Map<?, ?>> T applyIfEmpty(final T data, final Supplier<T> supplier) { }

    public static String applyIfEmpty(final String data, final Supplier<String> supplier) { }

    public static String orNull(final String data) { }

    // =================================================================================================================
    // APPLY IF NOT EMPTY
    // =================================================================================================================
    public static <T extends Collection<?>> T applyIfNotEmpty(final T data, final Supplier<T> supplier) { }

    public static <T extends Map<?, ?>> T applyIfNotEmpty(final T data, final Supplier<T> supplier) { }

    public static String applyIfNotEmpty(final String data, final Supplier<String> supplier) { }

    // =================================================================================================================
    // APPLY IF CHANGE
    // =================================================================================================================
    public static boolean applyIfChange(final boolean ref,
                                        final boolean newValue,
                                        final Consumer<Boolean> consumer) { }

    public static boolean applyIfChange(final short ref,
                                        final short newValue,
                                        final Consumer<Short> consumer) { }

    public static boolean applyIfChange(final int ref,
                                        final int newValue,
                                        final IntConsumer consumer) { }

    public static boolean applyIfChange(final float ref,
                                        final float newValue,
                                        final Consumer<Float> consumer)  { }

    public static boolean applyIfChange(final long ref, final long newValue, final LongConsumer consumer) { }

    public static boolean applyIfChange(final double ref, final double newValue, final DoubleConsumer consumer) { }

    public static <T extends Object> boolean applyIfChange(final T ref, final T newValue, final Consumer<T> consumer) { }


    public static <T extends Object> boolean applyIfChangeAndNotNull(final T ref,
                                                                     final T newValue,
                                                                     final Consumer<T> consumer) { }

    public static <T extends Object> boolean hasChange(final T ref, final T newValue)  { }

}
]]>
    </src>
</xml>
